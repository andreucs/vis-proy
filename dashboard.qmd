---
title: "My Dashboard"
format: dashboard
theme: minty
server: shiny
---


```{r}
#| context: setup
library(readr)
library(plotly)
library(dplyr)
library(sf)
library(mapSpain)
library(bslib)
library(bsicons)


turismo_receptor <- read_delim(
  "data/turismo_receptor_provincia_pais.csv",
  delim = ";",
  locale = locale(decimal_mark = ",", encoding = "ISO-8859-1"),
  col_types = cols(
    AÑO = col_double(),
    MES = col_double(),
    TURISTAS = col_double(),
    ESTANCIA_MEDIA = col_double(),
    PROVINCIA_DESTINO = col_character(),
    CONTINENTE_ORIGEN = col_character(),
    PAIS_ORIGEN = col_character(),
    PERNOCTACIONES = col_double()
  )
)


hex_prov <- esp_get_hex_prov() |>
  rename(PROVINCIA_DESTINO = ine.prov.name) |>
  select(PROVINCIA_DESTINO, label, codauto, nuts2.name, geom)


hex_prov_coords <- hex_prov$geom |> st_centroid() |> st_coordinates()
hex_prov$X <- hex_prov_coords[, 1]
hex_prov$Y <- hex_prov_coords[, 2]

tur_total_year <- turismo_receptor |>
                  group_by(AÑO, PROVINCIA_DESTINO) |>
                  summarise(m=sum(TURISTAS))

completo <- merge(tur_total_year, hex_prov, by = "PROVINCIA_DESTINO") |>
  st_as_sf()
```


# Page 1

## sidebar {.sidebar}

```{r}
selectInput("year", "Año", choices = unique(tur_total_year$AÑO))
```


## dasboardPanel

### firstRow {height=50%}

#### hexMap {width=45%}

```{r}
plotlyOutput("hexmap")
```

#### kpiLayout {width=55%}

##### kpiOnly {height=40%}

```{r}
value_box(
  title="Customer",
  value="$5000"
)
```

```{r}
value_box(
  title="Customer",
  value="$5000"
)
```

```{r}
value_box(
  title="Customer",
  value="$5000"
)
```


##### kpicharts {height=60%}

hello

```{r}
plotlyOutput("barplot")
```






### secondRow {height=50%}

#### {width=50%}

```{r}
plotlyOutput("barplot")
```

```{r}
navset_pill( 
    nav_panel("A", "Page A content"), 
    nav_panel("B", "Page B content"), 
    nav_panel("C", "Page C content"), 
    nav_menu( 
        "Other links", 
        nav_panel("D", "Panel D content"), 
        "----", 
        "Description:", 
        nav_item( 
            a("Shiny", href = "https://shiny.posit.co", target = "_blank") 
        ), 
    ), 
  )
```


```{r}
#| context: server


source("server/filter_functions.R")
source("server/hexmap_render.R")
source("server/barplot_click_render.R")

filtered_data <- get_filtered_data(input, completo)

render_hexmap(output, input, filtered_data, hex_prov)

render_barplot(output, input, turismo_receptor, hex_prov)


```